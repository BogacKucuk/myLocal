package com.ykb.corebanking.safedepositbox.safedepositboxbe;

import com.ykb.corebanking.safedepositbox.safedepositboxbe.batch.common.CustomJobParameters;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.ExitStatus;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobExecution;
import org.springframework.batch.core.JobParametersBuilder;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.actuate.autoconfigure.security.servlet.ManagementWebSecurityAutoConfiguration;
import org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.context.annotation.ComponentScan;

@Slf4j
@SpringBootApplication
@ComponentScan(basePackages = { "com.ykb.corebanking.safedepositbox.safedepositboxbe" })
@EnableCaching
@EnableFeignClients
@EnableDiscoveryClient
@EnableAutoConfiguration(exclude = { SecurityAutoConfiguration.class, ManagementWebSecurityAutoConfiguration.class })
public class SafedepositboxBeApplication {

    public static void main(String[] args) {

        // Mevcut kod: SPRING_APPLICATION_NAME environment var'ını setliyor
        String name = System.getenv("SPRING_APPLICATION_NAME");
        if (name != null) {
            System.setProperty("spring.application.name", name);
        }

        // Spring Boot context'i ayağa kaldıralım
        ConfigurableApplicationContext ctx = SpringApplication.run(SafedepositboxBeApplication.class, args);

        // ARGÜMAN KONTROLÜ: Eğer parametre varsa 0. argümanı jobName olarak alıp batch tetikleyeceğiz
        if (args != null && args.length > 0) {
            String jobName = args[0];  // Örneğin "dummyParameterInsertJob"
            int exitCode = 0;
            try {
                // Kalan argümanları (key=value) parse edip CustomJobParameters bean'ine koyabiliriz
                CustomJobParameters<String,Object> customParams = ctx.getBean(CustomJobParameters.class);
                for (int i = 1; i < args.length; i++) {
                    String[] kv = args[i].split("=");
                    if (kv.length == 2) {
                        customParams.addParameter(kv[0], kv[1]);
                    }
                }

                // Batch tetikleme
                JobLauncher jobLauncher = ctx.getBean(JobLauncher.class);
                Job job = ctx.getBean(jobName, Job.class);

                JobExecution jobExecution = jobLauncher.run(
                        job, 
                        new JobParametersBuilder()
                                .addLong("startTime", System.currentTimeMillis())
                                .toJobParameters()
                );

                if (!ExitStatus.COMPLETED.equals(jobExecution.getExitStatus())) {
                    exitCode = 1;  // job başarısız veya tamamlanmadı
                }
            } catch (Exception e) {
                log.error("Batch run failed with exception", e);
                exitCode = 1;
            } finally {
                ctx.close();
                System.exit(exitCode);
            }
        }

        // Argüman yoksa normal akış (Spring Boot web uygulaması, Feign, Discovery vs. tüm anotasyonlar devrede).
    }

}
