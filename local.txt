import React, { useEffect, useState } from "react";
import { Table, Checkbox, Typography, Icon } from "ykb-ui";
import { useShellCommunicator } from "ykb-shell";
import { useSelector, useDispatch } from "react-redux";
import { moneyDepositActions } from "../../store/moneyDeposit-store";
import { ApprovalType } from "../../constants/CommonConstants";
import { getCashApprovalType } from "../../utils/common/MoneyDepositUtils";
import { getDocumentsApi } from "../../API/MoneyDepositAPI";

const { Text } = Typography;

const MoneyDepositSmartControlTable = (props) => {
  const groupId = useSelector((state) => state.groupId);
  const dispatch = useDispatch();
  const notificationMode = useSelector((state) => state.notificationMode);
  const [tableData, setTableData] = useState(null);
  const { openTeslaViewerWithUrl, fireModuleEvent, callApi } =
    useShellCommunicator();

  const [selectedRow, setSelectedRow] = useState(null);
  const [bbtDocsChecks, setBbtDocsChecks] = useState([]);
  const [docsMap, setDocsMap] = useState({});

  useEffect(() => {
    getDocuments();
  }, [groupId]);

  const columns = [
    {
      title: "Kontrol Adı",
      dataIndex: "parameterName",
      key: "parameterName",
      render: (text, record) => generateLinks(text, record),
    },
    {
      title: "Kontrol Açıklaması",
      dataIndex: "description",
      key: "description",
    },
    {
      title: "Uygun",
      dataIndex: "status",
      width: "30%",
      key: "status",
      render: (text, record) => generateCheckButtons(text, record),
    },
  ];

  const generateTableData = (response) => {
    let data;
    if (groupId === "" || response?.bbtDocuments?.length === 0) {
      data = [
        {
          key: 1,
          parameterName: "Diğer İşlem Kontrolleri",
          description: "",
          isHeader: true,
          children: [],
        },
      ];
    } else {
      data = [
        {
          key: 1,
          parameterName: "Belge Kontrolleri",
          description: "",
          isHeader: true,
          children: [],
        },
        {
          key: 2,
          parameterName: "Diğer İşlem Kontrolleri",
          description: "",
          isHeader: true,
          children: [],
        },
      ];
    }
    setTableData(data);
    return data;
  };

  const generateLinks = (text, record) => {
    if (record.documentRemoteId != null) {
      return (
        <Text type="secondary" underline>
          {record.parameterName}
          <Icon name="external-link" />
        </Text>
      );
    } else {
      return <Text>{record.parameterName}</Text>;
    }
  };

  function openTesla(remoteId) {
    fireModuleEvent("wsGetDocumentUrl", {
      documentId: remoteId,
      documentUniqueKey: "undefined",
      userID: props?.externalData?.shellData?.user?.userCode,
      callbackContext: this,
      callbackFunction: function (documentUrl) {
        openTeslaViewerWithUrl({
          data: {
            urls: [documentUrl],
          },
        });
      },
    });
  }

  const generateCheckButtons = (text, record) => {
    if (record.isHeader) {
      return null;
    }
    if (record.isExist) {
      // Sunucudan "isExist = true" gelenler zaten seçili ve devre dışı
      return <Checkbox checked={true} disabled={true}></Checkbox>;
    } else {
      // Parent veya child ayrımı yok, tablo üzerinde tek checkbox
      return (
        <Checkbox
          id={record.key}
          checked={assignCheckState(record.key)}
          onChange={toggleChecked}
        />
      );
    }
  };

  /**
   * Recursive olarak tüm child kayıtlarını newChecked değerine set eder.
   * Ancak mutate (doğrudan item.checked=...) yerine,
   * her zaman yeni bir obje oluşturarak checksArr[childIndex] = {...}.
   */
  function checkAllChildren(docsMap, checksArr, parentKey, newChecked) {
    const childKeys = docsMap[parentKey]?.children || [];

    childKeys.forEach((childKey) => {
      const childIndex = checksArr.findIndex((c) => c.id === childKey);
      if (childIndex > -1) {
        // Her öğeyi kopyala ve updatedChecks dizisine geri koy
        checksArr[childIndex] = {
          ...checksArr[childIndex],
          checked: newChecked,
        };
        // rekurzif olarak alt child’ları da güncelle
        checkAllChildren(docsMap, checksArr, childKey, newChecked);
      }
    });
  }

  /**
   * Child true olduğunda parent’ın tüm kardeşleri de true ise
   * parent’ı da true yapar. (İsteğe göre ekleniyor.)
   */
  function updateParentIfAllChildrenChecked(docsMap, checksArr, childKey) {
    const parentKey = docsMap[childKey]?.parent;
    if (!parentKey) return;

    const siblings = docsMap[parentKey]?.children || [];
    const allSiblingsChecked = siblings.every((sKey) => {
      const found = checksArr.find((c) => c.id === sKey);
      return found?.checked === true;
    });

    if (allSiblingsChecked) {
      const parentIndex = checksArr.findIndex((c) => c.id === parentKey);
      if (parentIndex > -1) {
        checksArr[parentIndex] = {
          ...checksArr[parentIndex],
          checked: true,
        };
        // Büyük parent var mı diye kontrol (rekursif)
        updateParentIfAllChildrenChecked(docsMap, checksArr, parentKey);
      }
    }
  }

  /**
   * Checkbox event. 
   * 1) Hangi item'a tıklandıysa (parent/child) kopyasını oluşturup checked'i değiştirir.
   * 2) Parent'sa children'larını rekurzif günceller.
   * 3) Child'sa eğer hepsi true olduysa parent'ı da true yapar.
   */
  const toggleChecked = (e) => {
    const clickedId = e.target.id;
    // Hem diziyi hem de içindeki objeleri kopyalamak için .map(...) => {...item} kullanıyoruz
    const updatedChecks = bbtDocsChecks.map((item) => ({ ...item }));

    const foundIndex = updatedChecks.findIndex((item) => item.id === clickedId);
    if (foundIndex < 0) return;

    const oldValue = updatedChecks[foundIndex].checked;
    const newValue = !oldValue;

    updatedChecks[foundIndex] = {
      ...updatedChecks[foundIndex],
      checked: newValue,
    };

    // Eğer bu parent ise, altındaki tüm child’ları da aynı newValue yap
    if (docsMap[clickedId]?.children?.length > 0) {
      checkAllChildren(docsMap, updatedChecks, clickedId, newValue);
    }

    // Eğer child true olduysa parent’ı true yapma senaryosu (opsiyonel)
    if (newValue === true) {
      updateParentIfAllChildrenChecked(docsMap, updatedChecks, clickedId);
    }

    setBbtDocsChecks(updatedChecks);
    dispatch(moneyDepositActions.setBbtDocsChecks(updatedChecks));
  };

  /**
   * Mevcut state içinden bu checkbox’ın (id) checked değerini döndürür.
   */
  const assignCheckState = (id) => {
    const found = bbtDocsChecks.find((item) => item.id === id);
    return found ? found.checked : false;
  };

  /**
   * Backend’ten dönen belgeler için { id, checked: false } şeklinde initial state oluşturur.
   * Hem bbtDocuments hem de notExistsDocs
   */
  const generateCheckboxStates = (response) => {
    const checks = [];
    const addDocsToChecks = (docs) => {
      docs.forEach((doc) => {
        checks.push({
          id: doc.key,
          checked: false,
        });
        if (doc.children && doc.children.length > 0) {
          addDocsToChecks(doc.children);
        }
      });
    };

    if (response?.bbtDocuments?.length) {
      addDocsToChecks(response.bbtDocuments);
    }
    if (response?.notExistsDocs?.length) {
      addDocsToChecks(response.notExistsDocs);
    }

    return checks;
  };

  /**
   * docsMap:
   *  {
   *    "1702 - Tüm Kimlikler": { parent: null, children: ["1702 - Tüm Kimlikler-Ad Soyad", "1702 - Tüm Kimlikler-İmza", "1702 - Tüm Kimlikler-Tarih"] },
   *    "1702 - Tüm Kimlikler-Ad Soyad": { parent: "1702 - Tüm Kimlikler", children: [] },
   *    "1702 - Tüm Kimlikler-İmza": { parent: "1702 - Tüm Kimlikler", children: [] },
   *    "1702 - Tüm Kimlikler-Tarih": { parent: "1702 - Tüm Kimlikler", children: [] },
   *    ...
   *  }
   */
  const generateDocsMap = (docsArray, parentKey = null, mapObj = {}) => {
    docsArray.forEach((doc) => {
      // Bu doc key'i için ilk kez ekleniyorsa:
      if (!mapObj[doc.key]) {
        mapObj[doc.key] = { parent: parentKey, children: [] };
      } else {
        mapObj[doc.key].parent = parentKey;
      }

      // parentKey varsa, parent'ın children dizisine bu doc'un key'ini ekle
      if (parentKey) {
        if (!mapObj[parentKey]) {
          mapObj[parentKey] = { parent: null, children: [] };
        }
        mapObj[parentKey].children.push(doc.key);
      }

      // Çocuğu varsa rekurzif devam
      if (doc.children && doc.children.length > 0) {
        generateDocsMap(doc.children, doc.key, mapObj);
      }
    });
    return mapObj;
  };

  const generateDocsMapWrapper = (response) => {
    let mapObj = {};
    if (response?.bbtDocuments?.length) {
      mapObj = generateDocsMap(response.bbtDocuments, null, mapObj);
    }
    if (response?.notExistsDocs?.length) {
      mapObj = generateDocsMap(response.notExistsDocs, null, mapObj);
    }
    return mapObj;
  };

  /**
   * Backend’ten veriyi çekip tabloyu doldurur, doc map'i ve checkbox state’ini oluşturur.
   */
  const getDocuments = async () => {
    if (groupId === null || groupId === undefined) {
      return;
    }
    const documentRequest = {
      parameterName: "moneydeposit_smartcontrol",
      groupId: groupId,
      processCode: ["PARYATVISION"],
    };

    dispatch(moneyDepositActions.setLoading(true));
    try {
      const response = await callApi(getDocumentsApi(documentRequest));
      const data = generateTableData(response);

      // docsMap oluştur
      const newDocMap = generateDocsMapWrapper(response);
      setDocsMap(newDocMap);

      // Checkbox state oluştur
      const documentChecks = generateCheckboxStates(response);
      setBbtDocsChecks(documentChecks);
      dispatch(moneyDepositActions.setBbtDocsChecks(documentChecks));

      // Tablonu doldur
      if (groupId === "" || response?.bbtDocuments?.length === 0) {
        data[0].children = response?.notExistsDocs;
      } else {
        data[0].children = response?.bbtDocuments;
        data[1].children = response?.notExistsDocs;
      }
      setTableData(data);

      dispatch(moneyDepositActions.setLoading(false));
    } catch (ex) {
      dispatch(moneyDepositActions.setLoading(false));
    }
  };

  /**
   * Tabloda satır seçildiğinde Tesla Viewer açma vb.
   */
  const onRowSelected = (_, selectedRow) => {
    setSelectedRow(selectedRow[0]);
    if (selectedRow[0]?.documentRemoteId) {
      openTesla(selectedRow[0].documentRemoteId);
    }
  };

  const onRowClicked = (record) => {
    onRowSelected([record.key], [record]);
  };

  return (
    getCashApprovalType(notificationMode) === ApprovalType.LIMIT && (
      <Table
        columns={columns}
        data={tableData}
        expandable={{ defaultExpandAllRows: true }}
        onRow={(record) => {
          return {
            onClick: () => {
              onRowClicked(record);
            },
          };
        }}
      />
    )
  );
};

export default MoneyDepositSmartControlTable;
