package com.ykb.corebanking.vault.money.deposit.withdraw.service.impl;

import com.ykb.architecture.micro.error.exception.MicroException;
import com.ykb.corebanking.vault.money.deposit.withdraw.constant.NAPConstant.PROCESS_CODE;
import com.ykb.corebanking.vault.money.deposit.withdraw.constant.NotificationConstants;
import com.ykb.corebanking.vault.money.deposit.withdraw.dto.*;
import com.ykb.corebanking.vault.money.deposit.withdraw.exception.AccountException;
import com.ykb.corebanking.vault.money.deposit.withdraw.kafka.producer.CustomerNotificationProducer;
import com.ykb.corebanking.vault.money.deposit.withdraw.micro.clients.AccountClient;
import com.ykb.corebanking.vault.money.deposit.withdraw.request.CashTransactionStoredRequest;
import com.ykb.corebanking.vault.money.deposit.withdraw.response.AccountInfoResponse;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.junit.jupiter.SpringExtension;

import java.lang.reflect.Method;
import java.math.BigDecimal;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(SpringExtension.class)
class CustomerNotificationServiceTest {

    @InjectMocks
    private CustomerNotificationService customerNotificationService;

    @Mock
    private AccountClient accountClient;

    @Mock
    private CustomerNotificationProducer notificationProducer;

    @Captor
    private ArgumentCaptor<CustomerNotificationDTO> notificationCaptor;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    /**
     * Örnek basit bir test: WITHDRAW senaryosu.
     *  - Normal notification
     *  - Push notification (ayrı DTO)
     *  - Balance'ta currentBalance set edilmesi
     */
    @Test
    void testSendToNotificationQueue_WithDraw_PushNotification() throws AccountException {
        // Arrange
        CashTransactionDTO cashTransactionDTO = new CashTransactionDTO();
        cashTransactionDTO.setProcessCode(PROCESS_CODE.WITHDRAW.getProcessCode());
        cashTransactionDTO.setCreateDate(new Date());
        cashTransactionDTO.setUpdateDate(new Date());
        cashTransactionDTO.setBranchCode("326");
        cashTransactionDTO.setCreatedBy("tester");
        cashTransactionDTO.setUpdatedBy("tester");

        // Bir adet detail
        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAccountNo("100200");
        detail.setCurrency("TL");
        detail.setAccountCurrency("TL");
        detail.setAmount(BigDecimal.valueOf(1000));
        // accountAmount, kmvAmount gibi sahaları basit bırakalım
        detail.setAccountAmount(BigDecimal.valueOf(1000));
        detail.setKmvAmount(BigDecimal.ZERO);
        // Komisyon yok
        detail.setCommissionAmount(BigDecimal.ZERO);

        // Stored request
        ClientDTO client = new ClientDTO();
        client.setClientNo(999L);
        client.setClientName("JohnDoe");
        CashTransactionStoredRequest req = new CashTransactionStoredRequest();
        req.setClientInfo(client);
        // basit tutuyoruz
        req.setTakeCommissionFromTransactionAmount(false);
        req.setTakeTaxFromAccount(false);
        detail.setCashTransactionStoredRequest(req);

        List<CashTransactionDetailDTO> detailList = Collections.singletonList(detail);

        // Mock balance (currentBalance eklendi)
        BalanceDTO balanceDTO = new BalanceDTO();
        balanceDTO.setAvailableBalance(BigDecimal.valueOf(5000));
        balanceDTO.setCurrentBalance(BigDecimal.valueOf(7000));

        ResponseBalanceInfo balanceInfo = new ResponseBalanceInfo();
        balanceInfo.setBalanceDTO(balanceDTO);

        AccountInfoResponse accountInfo = new AccountInfoResponse();
        accountInfo.setIsFlexibleAccount(Boolean.FALSE);
        accountInfo.setIban("TRXXXX");

        when(accountClient.getBalanceInfo(eq("100200"), eq(false)))
                .thenReturn(ResponseEntity.ok(balanceInfo));
        when(accountClient.getAccountByAccountNoWithoutException(eq("100200")))
                .thenReturn(ResponseEntity.ok(accountInfo));

        // Act
        customerNotificationService.sendToNotificationQueue(cashTransactionDTO, detailList);

        // Assert
        // İki kez çağrı
        verify(notificationProducer, times(2)).sendMessageToNotificationQueue(notificationCaptor.capture());

        List<CustomerNotificationDTO> calls = notificationCaptor.getAllValues();
        assertEquals(2, calls.size());

        // 1. Normal
        CustomerNotificationDTO firstMsg = calls.get(0);
        assertEquals(NotificationConstants.PARCEK_NOTIFICATION_SHORTNAME,
                     firstMsg.getTransactionHeader().getJobCode(),
                     "WITHDRAW -> normal jobCode PARCEK_NOTIFICATION_SHORTNAME beklenir");

        // 2. Push
        CustomerNotificationDTO secondMsg = calls.get(1);
        assertEquals(NotificationConstants.PARCEK_PUSH_SHORTNAME,
                     secondMsg.getTransactionHeader().getJobCode(),
                     "WITHDRAW -> push jobCode PARCEK_PUSH_SHORTNAME beklenir");
    }

    /**
     * DEPOSIT senaryosu, push notification + flexibleAccount = PARYAT_NOTIFICATION_SHORTNAME2
     */
    @Test
    void testSendToNotificationQueue_Deposit_PushNotification() throws AccountException {
        // Arrange
        CashTransactionDTO dto = new CashTransactionDTO();
        dto.setProcessCode(PROCESS_CODE.DEPOSIT.getProcessCode());
        dto.setCreateDate(new Date());
        dto.setUpdateDate(new Date());
        dto.setBranchCode("327");
        dto.setCreatedBy("depUser");
        dto.setUpdatedBy("depUser");

        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAccountNo("987654");
        detail.setCurrency("TL");
        detail.setAccountCurrency("TL");
        detail.setAmount(BigDecimal.valueOf(2000));
        detail.setAccountAmount(BigDecimal.valueOf(2000));
        detail.setKmvAmount(BigDecimal.ZERO);
        detail.setCommissionAmount(BigDecimal.ZERO);

        ClientDTO client = new ClientDTO();
        client.setClientNo(1001L);
        client.setClientName("JaneDoe");
        CashTransactionStoredRequest req = new CashTransactionStoredRequest();
        req.setClientInfo(client);
        detail.setCashTransactionStoredRequest(req);

        List<CashTransactionDetailDTO> detailList = Collections.singletonList(detail);

        BalanceDTO balanceDTO = new BalanceDTO();
        balanceDTO.setAvailableBalance(BigDecimal.valueOf(6000));
        balanceDTO.setCurrentBalance(BigDecimal.valueOf(8000));
        ResponseBalanceInfo balanceInfo = new ResponseBalanceInfo();
        balanceInfo.setBalanceDTO(balanceDTO);

        AccountInfoResponse accountInfo = new AccountInfoResponse();
        // Flexible
        accountInfo.setIsFlexibleAccount(Boolean.TRUE);
        accountInfo.setIban("TRFLEX");
        when(accountClient.getBalanceInfo(eq("987654"), eq(false)))
                .thenReturn(ResponseEntity.ok(balanceInfo));
        when(accountClient.getAccountByAccountNoWithoutException(eq("987654")))
                .thenReturn(ResponseEntity.ok(accountInfo));

        // Act
        customerNotificationService.sendToNotificationQueue(dto, detailList);

        // Assert
        verify(notificationProducer, times(2)).sendMessageToNotificationQueue(notificationCaptor.capture());
        List<CustomerNotificationDTO> calls = notificationCaptor.getAllValues();
        assertEquals(2, calls.size());

        // 1. Normal
        assertEquals(NotificationConstants.PARYAT_NOTIFICATION_SHORTNAME2,
                calls.get(0).getTransactionHeader().getJobCode(),
                "DEPOSIT + flexible => PARYAT_NOTIFICATION_SHORTNAME2");

        // 2. Push
        assertEquals(NotificationConstants.PARYAT_PUSH_SHORTNAME,
                calls.get(1).getTransactionHeader().getJobCode(),
                "DEPOSIT push => PARYAT_PUSH_SHORTNAME");
    }

    /**
     * Test: Null list -> AccountException
     */
    @Test
    void testSendToNotificationQueue_NullDetailList() {
        CashTransactionDTO dto = new CashTransactionDTO();
        assertThrows(AccountException.class, () ->
                customerNotificationService.sendToNotificationQueue(dto, null));
    }

    /**
     * getBalanceInfo fail -> AccountException
     */
    @Test
    void testSendToNotificationQueue_BalanceInfoFails() {
        CashTransactionDTO dto = new CashTransactionDTO();
        dto.setProcessCode(PROCESS_CODE.WITHDRAW.getProcessCode());

        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAccountNo("ACCFAIL");
        List<CashTransactionDetailDTO> detailList = Collections.singletonList(detail);

        when(accountClient.getBalanceInfo(eq("ACCFAIL"), eq(false)))
                .thenThrow(new RuntimeException("some error"));

        assertThrows(AccountException.class, () ->
                customerNotificationService.sendToNotificationQueue(dto, detailList));
    }

    /**
     * getAccountByAccountNoWithoutException dönerken body null -> AccountException
     */
    @Test
    void testGetParameters_AccountBodyNull() {
        CashTransactionDTO dto = new CashTransactionDTO();
        dto.setProcessCode(PROCESS_CODE.DEPOSIT.getProcessCode());
        dto.setCreateDate(new Date());
        dto.setUpdateDate(new Date());

        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAccountNo("ACCNULL");
        detail.setAccountCurrency("TL");
        detail.setCurrency("TL");
        detail.setAmount(BigDecimal.valueOf(1000));

        CashTransactionStoredRequest req = new CashTransactionStoredRequest();
        ClientDTO client = new ClientDTO();
        client.setClientNo(123L);
        req.setClientInfo(client);
        detail.setCashTransactionStoredRequest(req);

        List<CashTransactionDetailDTO> detailList = Collections.singletonList(detail);

        // balance normal
        BalanceDTO balanceDTO = new BalanceDTO();
        balanceDTO.setAvailableBalance(BigDecimal.valueOf(1000));
        balanceDTO.setCurrentBalance(BigDecimal.valueOf(2000));
        ResponseBalanceInfo balanceInfo = new ResponseBalanceInfo();
        balanceInfo.setBalanceDTO(balanceDTO);
        when(accountClient.getBalanceInfo(eq("ACCNULL"), eq(false)))
                .thenReturn(ResponseEntity.ok(balanceInfo));

        // account body null
        when(accountClient.getAccountByAccountNoWithoutException(eq("ACCNULL")))
                .thenReturn(ResponseEntity.ok(null));

        assertThrows(AccountException.class, () ->
                customerNotificationService.getParameters(dto, detailList));
    }

    /**
     * Tüm parametreler normal, getParameters SUCCESS
     */
    @Test
    void testGetParameters_Success() throws AccountException {
        // Arrange
        CashTransactionDTO dto = new CashTransactionDTO();
        dto.setProcessCode(PROCESS_CODE.WITHDRAW.getProcessCode());
        dto.setCreateDate(new Date());
        dto.setUpdateDate(new Date());
        dto.setCreatedBy("paramTester");
        dto.setUpdatedBy("paramTester");

        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAccountNo("100200");
        detail.setCurrency("USD");
        detail.setAccountCurrency("USD");
        detail.setAmount(BigDecimal.valueOf(500));
        detail.setAccountAmount(BigDecimal.valueOf(500));
        detail.setKmvAmount(BigDecimal.ZERO);
        detail.setCommissionAmount(BigDecimal.ZERO);

        ClientDTO client = new ClientDTO();
        client.setClientNo(987L);
        client.setClientName("Jack");
        CashTransactionStoredRequest req = new CashTransactionStoredRequest();
        req.setClientInfo(client);
        req.setTakeCommissionFromTransactionAmount(false);
        detail.setCashTransactionStoredRequest(req);

        List<CashTransactionDetailDTO> detailList = Collections.singletonList(detail);

        BalanceDTO balanceDTO = new BalanceDTO();
        balanceDTO.setAvailableBalance(BigDecimal.valueOf(3000));
        balanceDTO.setCurrentBalance(BigDecimal.valueOf(4000));
        ResponseBalanceInfo balanceInfo = new ResponseBalanceInfo();
        balanceInfo.setBalanceDTO(balanceDTO);

        AccountInfoResponse accountInfo = new AccountInfoResponse();
        accountInfo.setIsFlexibleAccount(false);
        accountInfo.setIban("TRTEST");

        when(accountClient.getBalanceInfo(eq("100200"), eq(false)))
                .thenReturn(ResponseEntity.ok(balanceInfo));
        when(accountClient.getAccountByAccountNoWithoutException(eq("100200")))
                .thenReturn(ResponseEntity.ok(accountInfo));

        // Act
        CustomerNotificationDTO result = customerNotificationService.getParameters(dto, detailList);

        // Assert
        assertNotNull(result);
        assertNotNull(result.getTransactionHeader());
        assertNotNull(result.getTransactionDetails());
        // totalBalance parametresine currentBalance dökümü
        Optional<TransactionDetails> totalBalanceOpt = result.getTransactionDetails().stream()
                .filter(t -> "totalBalance".equals(t.getParameterName()))
                .findFirst();
        assertTrue(totalBalanceOpt.isPresent());
        assertTrue(totalBalanceOpt.get().getParameterValue().contains("4.000"));
    }

    // -------------------------------------------------
    // Aşağıdan itibaren "calculateAmountTextAndIsKgvIncluded" vb.
    // bölümlerin testleri reflection ile basitçe yazılabilir.
    // Kod epey dallı. Basit testlerle coverage yükseltelim.
    // -------------------------------------------------

    /**
     * Örnek: Komisyon yok, takeTaxFromAccount=false => normal
     */
    @Test
    void testCalculateAmount_NoCommission_NoTax() throws Exception {
        CashTransactionDTO cashTransactionDTO = new CashTransactionDTO();
        cashTransactionDTO.setProcessCode(PROCESS_CODE.WITHDRAW.getProcessCode());

        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAmount(BigDecimal.valueOf(1000));
        detail.setAccountAmount(BigDecimal.valueOf(1000));
        detail.setKmvAmount(BigDecimal.ZERO);
        detail.setCommissionAmount(BigDecimal.ZERO);
        detail.setCurrency("USD");
        detail.setAccountCurrency("USD");

        CashTransactionStoredRequest req = new CashTransactionStoredRequest();
        req.setTakeCommissionFromTransactionAmount(false);
        req.setTakeTaxFromAccount(false); 
        detail.setCashTransactionStoredRequest(req);

        Method method = CustomerNotificationService.class.getDeclaredMethod(
                "calculateAmountTextAndIsKgvIncluded", CashTransactionDTO.class, List.class);
        method.setAccessible(true);

        @SuppressWarnings("unchecked")
        CustomerNotificationService.AmountCalculationResult result =
                (CustomerNotificationService.AmountCalculationResult) method.invoke(
                        customerNotificationService,
                        cashTransactionDTO,
                        Collections.singletonList(detail)
                );

        // Komisyon yok, currency==accountCurrency => "1.000,00 USD" (Almanca format)
        assertTrue(result.getAmountText().contains("1.000,00"));
        assertTrue(result.getAmountText().contains("USD"));
        assertFalse(result.getIsKgvIncluded());
    }

    /**
     * Komisyon var, komisyon haricen alınıyor, takeTaxFromAccount=false
     */
    @Test
    void testCalculateAmount_WithCommission_Externally_NoTax() throws Exception {
        CashTransactionDTO dto = new CashTransactionDTO();
        dto.setProcessCode(PROCESS_CODE.DEPOSIT.getProcessCode());

        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAmount(BigDecimal.valueOf(1000));
        detail.setAccountAmount(BigDecimal.valueOf(1000));
        detail.setCommissionAmount(BigDecimal.valueOf(50));
        detail.setKmvAmount(BigDecimal.ZERO);
        detail.setCurrency("TL");
        detail.setAccountCurrency("TL");

        CashTransactionStoredRequest req = new CashTransactionStoredRequest();
        // Komisyon tutardan alınmıyor => false
        req.setTakeCommissionFromTransactionAmount(false);
        // Tax da yok
        req.setTakeTaxFromAccount(false);
        detail.setCashTransactionStoredRequest(req);

        Method method = CustomerNotificationService.class.getDeclaredMethod(
                "calculateAmountTextAndIsKgvIncluded", CashTransactionDTO.class, List.class);
        method.setAccessible(true);

        CustomerNotificationService.AmountCalculationResult result =
                (CustomerNotificationService.AmountCalculationResult) method.invoke(customerNotificationService,
                        dto, Collections.singletonList(detail));

        // Komisyon var, ama harici => "1000,00 TL"
        // isKgvIncluded = false
        assertTrue(result.getAmountText().contains("1000,00 TL"));
        assertFalse(result.getIsKgvIncluded());
    }

    /**
     * Komisyon var, komisyon tutardan, takeTaxFromAccount=true, KMV>0 => KGV included
     */
    @Test
    void testCalculateAmount_WithCommission_TakenFromAmount_TaxAndKmv() throws Exception {
        CashTransactionDTO dto = new CashTransactionDTO();
        // WithDRAW senaryosunda tutara komisyon ekleniyor
        dto.setProcessCode(PROCESS_CODE.WITHDRAW.getProcessCode());

        CashTransactionDetailDTO detail = new CashTransactionDetailDTO();
        detail.setAmount(BigDecimal.valueOf(1000));
        detail.setAccountAmount(BigDecimal.valueOf(900)); // diyelim
        detail.setCommissionAmount(BigDecimal.valueOf(50));
        detail.setKmvAmount(BigDecimal.valueOf(100)); // KMV>0
        detail.setCurrency("USD");
        detail.setAccountCurrency("EUR");

        CashTransactionStoredRequest req = new CashTransactionStoredRequest();
        // Komisyon tutardan alınıyor => true
        req.setTakeCommissionFromTransactionAmount(true);
        // Vergi (KMV) account'tan => true
        req.setTakeTaxFromAccount(true);

        detail.setCashTransactionStoredRequest(req);

        Method method = CustomerNotificationService.class.getDeclaredMethod(
                "calculateAmountTextAndIsKgvIncluded", CashTransactionDTO.class, List.class);
        method.setAccessible(true);

        CustomerNotificationService.AmountCalculationResult result =
                (CustomerNotificationService.AmountCalculationResult) method.invoke(customerNotificationService,
                        dto, Collections.singletonList(detail));

        // Beklenti: isKgvIncluded = true
        assertTrue(result.getIsKgvIncluded(), "KMV>0 + takeTaxFromAccount=true => isKgvIncluded");
        assertNotNull(result.getAmountText());
    }

    /**
     * FormatDate basit test
     */
    @Test
    void testFormatDate() throws Exception {
        Method m = CustomerNotificationService.class
                .getDeclaredMethod("formatDate", Date.class);
        m.setAccessible(true);

        Calendar c = Calendar.getInstance();
        c.set(Calendar.HOUR_OF_DAY, 9);
        c.set(Calendar.MINUTE, 15);

        String output = (String) m.invoke(customerNotificationService, c.getTime());
        // "09:15" bekleriz
        assertEquals("09:15", output);
    }

    /**
     * FormatCurrency basit test
     */
    @Test
    void testFormatCurrency() throws Exception {
        Method m = CustomerNotificationService.class
                .getDeclaredMethod("formatCurrency", String.class);
        m.setAccessible(true);

        String output = (String) m.invoke(customerNotificationService, "1234.56");
        // Alman locale -> "1.234,56" gibi bir sonuç
        assertTrue(output.contains(",56"));
    }
}
