import { expect } from 'chai';
import { fireEvent, render, screen, waitFor } from '@testing-library/react';
import * as arkMultiLanguage from '@ark-technical-modules/ark-multilanguage';
import { ArkInvoker, HttpMethod } from '@ark-technical-modules/ark-api-invoker';
import { Provider } from '@ark-technical-components/ark-react-state-management';
import { BrowserRouter } from 'react-router-dom';
import { buildMockResponse, resetStoreCache } from '../../../test/testUtils';
import { getAppUrlForInvoker } from '@ark-technical-modules/ark-utils';
import { EfaButtonElement } from '@efa-web-components/efa-button';
import { EfaPopupElement } from '@efa-web-components/efa-popup';
import * as popupModule from '@efa-web-components/efa-popup';                       // <<< EfaPopup stub için
import * as lastApi from '../../../store/apis/LastTransactionsApi';               // <<< Hook stub için
import { store } from '../../../store';
import MainMoneyWithdrawComponent from '../MainMoneyWithdrawComponent';
import { EfaInfoboxElement } from '@efa-web-components/efa-infobox';
import React, { JSX } from 'react';
import sinon from 'sinon';
import { retrieveData } from '../../../test/testData/opCode';
import { setOperationCode } from '../../../store/slices/operationCodeSlice';
import { EfaAnchorElement } from '@efa-web-components/efa-anchor';

const MainMoneyWithdrawComponentWithRoute = (): JSX.Element => (
  <Provider store={store}>
    <BrowserRouter>
      <MainMoneyWithdrawComponent type={'money-withdraw'} />
    </BrowserRouter>
  </Provider>
);

const arkInvoker = new ArkInvoker();
const serverOpCodeResponse = buildMockResponse(retrieveData(1));

describe('MainMoneyWithdrawComponent Component', () => {
  let sandbox: sinon.SinonSandbox;
  let invokerStub: sinon.SinonStub;
  let getOperationCodeStub: sinon.SinonStub;
  let popupStub: sinon.SinonStub;
  let lazyStub: sinon.SinonStub;

  //
  // 1) Bu `before` bloğu : tüm stub’ları bir kere kuruyoruz
  //
  before(async () => {
    await arkMultiLanguage.init('/locales/');
    sandbox = sinon.createSandbox();

    // --- EfaPopup stub’u: visible=true olunca <div data-testid=…> render etsin ---
    popupStub = sandbox
      .stub(popupModule, 'default')
      .callsFake(({ visible, 'data-testid': tId, children }) =>
        visible ? <div data-testid={tId}>{children}</div> : null
      );

    // --- useLazyGetLastTransactionsQuery hook stub’u ---
    // Component mount olur olmaz, trigger ve hazır data dönsün:
    const fakeTx = [{
      valueDate: new Date().toISOString(),
      channel: 'Şube X',              // Transaction.type’deki `channel` alanı
      customerAccount: 'ACC123',
      transactionAmount: 500,
      currency: 'TL',
      opCode: 'D',
      operationType: '',
      customerNumber: 0,
      storedRequest: ''
    }];
    lazyStub = sandbox
      .stub(lastApi, 'useLazyGetLastTransactionsQuery')
      .returns([
        () => Promise.resolve(),      // trigger()
        { data: { transactions: fakeTx }, isLoading: false, error: null }
      ]);

    // --- ArkInvoker stub’ları ---
    invokerStub = sandbox.stub(arkInvoker, 'callMethod');
    getOperationCodeStub = invokerStub
      .withArgs(
        HttpMethod.POST,
        sinon.match.has('url', getAppUrlForInvoker('getOperationCode'))
      )
      .resolves(serverOpCodeResponse);

    // (İsterseniz getLastTransactions endpoint’ini de stub’layabilirsiniz,
    //  ama hook stub’u yeterli olacaktır, o gerçek çağrıyı engelliyor.)
  });

  //
  // 2) Her testten önce render edilsin
  //
  beforeEach(() => {
    resetStoreCache();
    render(<MainMoneyWithdrawComponentWithRoute />);
  });

  //
  // 3) Her testten sonra tüm sandbox temizlensin
  //
  afterEach(() => {
    sandbox.restore();
  });

  it('renders the component', async () => {
    const infobox: EfaInfoboxElement = await screen.findByTestId('customer-info-added-hint-infobox');
    await waitFor(() => {
      expect(infobox).to.exist;
    });
  });

  it('click add-customer-button', async () => {
    const addButton: EfaButtonElement = await screen.findByTestId('add-customer-button');
    const lastTransactionPopup: EfaPopupElement = await screen.findByTestId('last-transaction-link');
    const alertPopup: EfaPopupElement = await screen.findByTestId('money-withdraw-info-alert-popup');
    const surveyPopup: EfaPopupElement = await screen.findByTestId('surver-popupId');
    const addCustomerPopup: EfaPopupElement = await screen.findByTestId('add-customer-popup');
    const infobox: EfaInfoboxElement = await screen.findByTestId('customer-info-added-hint-infobox');

    fireEvent(lastTransactionPopup, new CustomEvent('close', { detail: {} }));
    fireEvent(addCustomerPopup, new CustomEvent('close', { detail: {} }));
    fireEvent(surveyPopup, new CustomEvent('close', { detail: {} }));
    fireEvent(alertPopup, new CustomEvent('close', { detail: {} }));
    fireEvent(infobox, new CustomEvent('close', { detail: {} }));

    await waitFor(() => {
      expect(addButton).to.exist;
      expect(lastTransactionPopup).to.exist;
      expect(addCustomerPopup).to.exist;
      expect(alertPopup).to.exist;
      expect(surveyPopup).to.exist;
      expect(infobox).to.exist;
    });
  });

  it('should close the last transaction popup', async () => {
    try {
      const lastTransactionPopup: EfaPopupElement = await screen.findByTestId('last-transaction-popup');
      await waitFor(() => {
        expect(lastTransactionPopup).to.exist;
      });
      fireEvent(lastTransactionPopup, new CustomEvent('close', { detail: {} }));
    } catch (error) {
      expect(true).to.be.true; // yoksa test geçsin
    }
  });

  it('should call getOpCode', async () => {
    await waitFor(() => {
      expect(getOperationCodeStub.callCount).to.be.greaterThan(0);
    });
  });

  it('should call getOpCode with KAS-FIS response', () => {
    store.dispatch(setOperationCode(retrieveData(2)));
  });

  it('should call getOpCode with HES-KAS-KEN response', () => {
    store.dispatch(setOperationCode(retrieveData(3)));
  });

  it('should call getOpCode with HES-KAS-FIS response', () => {
    store.dispatch(setOperationCode(retrieveData(4)));
  });

  it('last trx anchor clicked on MainMoneyWithdrawComponent', async function() {
    const anchor: EfaAnchorElement = await screen.findByTestId('last-transaction-link');
    expect(anchor).to.exist;

    fireEvent.click(anchor);

    // popup’un DOM’da belirip belirmediğini bekle:
    await waitFor(() => {
      const popup = screen.queryByTestId('last-transaction-popup');
      expect(popup).to.exist;
    });

    const closeButton: EfaButtonElement = await screen.findByTestId('last-transactions-closeBtn');
    fireEvent.click(closeButton);

    // kapandı mı kontrol et:
    await waitFor(() => {
      const popup = screen.queryByTestId('last-transaction-popup');
      expect(popup).to.not.exist;
    });
  });
});
